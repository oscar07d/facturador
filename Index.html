<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Facturas OSCAR 07D Studios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<style>
		/* General Styles */
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background-color: #f4f6f8;
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    padding: 20px;
    animation: fadeIn 0.5s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.invoice-generator {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
    width: 95%;
    max-width: 1000px;
    margin: 20px auto;
    padding: 30px;
}

/* Header Styles */
.invoice-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding-bottom: 20px;
    border-bottom: 1px solid #eee;
}

.invoice-header-left {
    display: flex;
    align-items: flex-start;
    gap: 20px;
}

.logo-upload {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-right: 20px;
    width: auto;
    max-width: 170px; /* Para evitar que el botón se desborde */
    height: auto;
    overflow: hidden;
    border-radius: 10px;
}

#logo-preview {
    max-width: 150px;
    max-height: 150px;
    height: auto;
    margin-bottom: 10px;
    border-radius: 10px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    object-fit: contain;
}

.business-details {
    text-align: left;
}

.business-details h2 {
    margin-top: 0;
    margin-bottom: 8px;
    color: #333;
    font-size: 1.5em;
}

.business-details p {
    margin-bottom: 5px;
    color: #666;
    font-size: 0.9em;
}

.business-details textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 8px;
    resize: vertical;
    font-size: 0.9em;
}

.invoice-header-right {
    text-align: right;
}

.invoice-header-right .form-group {
    margin-bottom: 10px;
}
.invoice-header-right .form-group label {
    display: block;
    margin-bottom: 5px; /* Ajustado */
    color: #555;
    font-weight: bold;
    font-size: 0.95em;
}
.invoice-header-right .form-group input {
    width: calc(100% - 24px); /* Para compensar padding */
    max-width: 200px; /* Para que no sea demasiado ancho */
    padding: 10px; /* Unificado */
    border: 1px solid #ccc;
    border-radius: 50px; /* Unificado */
    box-sizing: border-box;
    font-size: 0.9em; /* Unificado */
    color: #333;
    background-color: #f8f8f8;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
}


/* Section Styles */
.invoice-section {
    margin-top: 25px;
    padding: 25px;
    border-bottom: 1px solid #eee;
}

.section-title {
    color: #333;
    border-bottom: 3px solid #007bff;
    padding-bottom: 12px;
    font-size: 1.3em;
    margin-bottom: 15px;
}

/* Form Styles */
.form-row {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    color: #555;
    font-weight: bold;
    font-size: 0.95em;
}

.form-group input,
.form-group select {
    width: 100%;
    padding: 12px;
    border: 1px solid #ccc;
    border-radius: 50px;
    box-sizing: border-box;
    font-size: 0.95em;
    color: #333;
    background-color: #f8f8f8;
    box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.form-group input:focus,
.form-group select:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
}

.form-group select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3E%3Cpath fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 8px 8px;
    padding-right: 24px;
}

.form-title {
    margin-top: 15px;
    color: #444;
    border-bottom: 1px solid #ddd;
    padding-bottom: 5px;
}

/* Client Section Styles */
.client-selection {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 15px;
}

.client-actions {
    display: flex;
    gap: 10px;
}
.client-actions.hidden, /* Para elementos que usan la clase hidden para ocultarse */
.edit-client-form.hidden {
    display: none !important;
}


/* Item Table Styles */
.item-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
}

.item-table th,
.item-table td {
    padding: 12px;
    text-align: left;
    border-bottom: 1px solid #eee;
}

.item-table th {
    background-color: #f0f0f0;
    font-weight: bold;
    color: #444;
}

/* Total Styles */
.totals {
    text-align: right;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #eee;
}

.total-row {
    display: flex;
    justify-content: flex-end;
    align-items: center;
    margin-bottom: 8px;
}

.total-row label {
    margin-left: 15px;
    font-weight: bold;
    color: #555;
    width: 120px;
    font-size: 1em;
}

.total-row input {
    width: 180px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 50px;
    box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
    text-align: right;
    font-size: 1em;
}

/* Action Styles */
.actions {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

/* Estilos para la búsqueda de factura */
.search-invoice {
    display: flex;
    gap: 10px;
    margin-bottom: 25px;
    align-items: center;
}

.search-invoice label {
    font-weight: bold;
    color: #546e7a;
    margin-right: 10px;
}

#search-code {
    padding: 12px;
    border: 1px solid #e0e0e0; /* Unificado */
    border-radius: 50px;
    font-size: 1em;
    width: 250px;
    box-sizing: border-box;
    transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

#search-code:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
}

#search-invoice-btn {
    background: linear-gradient(135deg, #f0ad4e, #eea236);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 20px;
    cursor: pointer;
    font-size: 1em;
    transition: background-color 0.3s ease, transform 0.2s ease;
}

#search-invoice-btn:hover {
    background-color: #eea236; /* Cambiado para consistencia con la especificación, aunque linear-gradient es más complejo */
    transform: scale(1.02);
}

.search-results {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #ddd;
    border-radius: 8px;
    background-color: #f5f5f5;
    color: #263238;
    font-size: 0.9em;
    display: none; /* Ocultar por defecto */
}

.search-results.show { /* Usar .show para mostrar */
    display: block;
}

.search-results h3 {
    margin-top: 0;
    margin-bottom: 10px;
    color: #37474f;
    border-bottom: 1px solid #e0e0e0;
    padding-bottom: 5px;
}

/* Estilos para el selector de cliente */
#select-client {
    width: 100%;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 50px;
    box-sizing: border-box;
    font-size: 0.95em;
    cursor: pointer;
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 4 5'%3E%3Cpath fill='%23666' d='M2 0L0 2h4zm0 5L0 3h4z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
    background-size: 8px 8px;
    padding-right: 24px;
    transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
#select-client option.deleted {
    color: #999;
    font-style: italic;
}


#select-client:focus {
    border-color: #007bff;
    outline: none;
    box-shadow: 0 0 5px rgba(0, 123, 255, 0.2);
}

/* Button Styles */
.button {
    background: linear-gradient(135deg, #6dd5ed, #2193b0);
    color: white;
    padding: 10px 18px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-size: 0.95em;
    transition: background 0.3s ease, transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.button:hover {
    background: linear-gradient(135deg, #2193b0, #6dd5ed);
    transform: scale(1.01);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
}

.button.primary {
    background: linear-gradient(135deg, #4caf50, #81c784);
}

.button.primary:hover {
    background: linear-gradient(135deg, #81c784, #4caf50);
}

.button.danger {
    background-color: #f44336;
}
.button.danger:hover {
    background-color: #d32f2f;
}


.button.success {
    background-color: #17a2b8;  /* Usando este en lugar de gradient para consistencia con el ejemplo de whatsapp y email */
}

.button.success:hover {
    background-color: #138496;
}

.button.small {
    padding: 5px 10px;
    font-size: 0.8em;
    border-radius: 20px;
}

#add-item-btn {
    padding: 6px 10px;
    font-size: 0.8em;
    border-radius: 4px;
    background: #f0f0f0;
    color: #333;
    border: 1px solid #ccc;
    box-shadow: none;
    transition: background-color 0.2s ease, color 0.2s ease;
}

#add-item-btn:hover {
    background-color: #e0e0e0;
    color: #222;
}

/* Share Options Styles */
.share-options {
    display: flex;
    align-items: center;
    gap: 15px;
}

.share-options label {
    font-weight: bold;
    color: #555;
    font-size: 0.95em;
}

.export-options {
    display: none; /* Ocultar por defecto */
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
}

.export-options.show { /* Usar .show para mostrar */
    display: flex;
}

/* Status Message Styles */
.status-message {
    margin-top: 25px;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    opacity: 0; /* Inicialmente oculto */
    transition: opacity 0.5s ease-in-out;
}

.status-message.error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
.status-message.success { /* Añadido estilo para mensajes de éxito */
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}


	</style>
</head>
<body>
    <div class="invoice-generator">
        <header class="invoice-header">
            <div class="invoice-header-left">
                <div class="logo-upload">
                    <img id="logo-preview" src="img/Isologo.svg" alt="Logo del Comercio">
                    <button id="upload-logo-btn" class="button">Cargar Logo</button>
                    <input type="file" id="upload-logo-input" accept="image/png, image/svg+xml" style="display: none;">
                </div>
                <div class="business-details">
                    <h2>OSCAR 07D Studios</h2>
                    <p class="contact">Contacto: 3023935392</p>
                    <textarea id="business-details" placeholder="Detalles adicionales del comercio"></textarea>
                </div>
            </div>
            <div class="invoice-header-right">
                <div class="form-group">
                    <label for="invoice-date">Fecha Factura:</label>
                    <input type="text" id="invoice-date" name="invoice-date" readonly>
                </div>
                <div class="form-group">
                    <label for="invoice-number">Nº Factura:</label>
                    <input type="text" id="invoice-number" name="invoice-number" readonly>
                </div>
            </div>
        </header>

        <section class="invoice-section">
            <h2 class="section-title">Cliente</h2>
            <div class="client-selection">
                <label for="select-client">Cliente Existente:</label>
                <select id="select-client" name="select-client">
                    <option value="">-- Seleccionar Cliente --</option>
                </select>
                <div class="client-actions hidden" id="client-actions">
                    <button id="delete-client-btn" class="button danger small">Eliminar</button>
                    <button id="recover-client-btn" class="button primary small hidden">Recuperar</button>
                </div>
            </div>

            <div class="new-client-form">
                <h3 class="form-title">Nuevo Cliente</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-client-name">Nombre:</label>
                        <input type="text" id="new-client-name" name="new-client-name" placeholder="Nombre">
                    </div>
                    <div class="form-group">
                        <label for="new-client-email">Email:</label>
                        <input type="email" id="new-client-email" name="new-client-email" placeholder="Email">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-client-address">Dirección:</label>
                        <input type="text" id="new-client-address" name="new-client-address" placeholder="Dirección">
                    </div>
                    <div class="form-group">
                        <label for="new-client-phone">Teléfono:</label>
                        <input type="tel" id="new-client-phone" name="new-client-phone" placeholder="Teléfono">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="new-client-payment-status">Estado Pago:</label>
                        <select id="new-client-payment-status" name="new-client-payment-status">
                            <option value="paid">Pagado</option>
                            <option value="pending" selected>Pendiente</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="edit-client-form hidden" id="edit-client-form">
                <h3 class="form-title">Editar Cliente</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-client-name">Nombre:</label>
                        <input type="text" id="edit-client-name" name="edit-client-name" placeholder="Nombre">
                    </div>
                    <div class="form-group">
                        <label for="edit-client-email">Email:</label>
                        <input type="email" id="edit-client-email" name="edit-client-email" placeholder="Email">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-client-address">Dirección:</label>
                        <input type="text" id="edit-client-address" name="edit-client-address" placeholder="Dirección">
                    </div>
                    <div class="form-group">
                        <label for="edit-client-phone">Teléfono:</label>
                        <input type="tel" id="edit-client-phone" name="edit-client-phone" placeholder="Teléfono">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="edit-client-payment-status">Estado Pago:</label>
                        <select id="edit-client-payment-status" name="edit-client-payment-status">
                            <option value="paid">Pagado</option>
                            <option value="pending">Pendiente</option>
                        </select>
                    </div>
                </div>
                <button id="save-client-btn" class="button primary small">Guardar</button>
            </div>

            <div class="client-payment-status" id="client-payment-status">
                <!-- Estado de pago del cliente se mostrará aquí -->
            </div>
        </section>

        <section class="invoice-section">
            <h2 class="section-title">Detalles de la Factura</h2>
            <div class="add-item-form">
                <div class="form-row">
                    <div class="form-group">
                        <label for="item-description">Descripción:</label>
                        <input type="text" id="item-description" name="item-description" list="product-list">
                        <datalist id="product-list">
                            </datalist>
                    </div>
                    <div class="form-group">
                        <label for="item-quantity">Cantidad:</label>
                        <input type="number" id="item-quantity" name="item-quantity" value="1">
                    </div>
                    <div class="form-group">
                        <label for="item-price">Precio:</label>
                        <input type="number" id="item-price" name="item-price" value="0.00" step="0.01">
                    </div>
                    <button id="add-item-btn" class="button">Agregar</button>
                </div>
            </div>
            <table class="item-table">
                <thead>
                    <tr>
                        <th>Descripción</th>
                        <th>Cantidad</th>
                        <th>Precio</th>
                        <th>Importe</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="items-list">
                    </tbody>
            </table>
        </section>

        <section class="invoice-section">
            <h2 class="section-title">Totales</h2>
            <div class="totals">
                <div class="total-row">
                    <label for="subtotal">Subtotal:</label>
                    <input type="text" id="subtotal" name="subtotal" value="0.00" readonly>
                </div>
                <div class="total-row">
                    <label for="tax">Impuesto (%):</label>
                    <input type="number" id="tax" name="tax" value="0" step="0.01">
                </div>
                <div class="total-row">
                    <label for="total">Total:</label>
                    <input type="text" id="total" name="total" value="0.00" readonly>
                </div>
            </div>
        </section>

        <section class="invoice-section">
            <h2 class="section-title">Acciones</h2>
            <div class="actions">
                <div class="search-invoice">
                    <label for="search-code">Buscar Factura:</label>
                    <input type="text" id="search-code" name="search-code" placeholder="Código">
                    <button id="search-invoice-btn" class="button">Buscar</button>
                </div>
                <div class="search-results" id="search-results">
                    <!-- Resultados de la búsqueda se mostrarán aquí -->
                </div>

                <button id="generate-invoice-btn" class="button primary">Generar Factura</button>
                <div class="form-group">
                    <label for="invoice-format">Formato:</label>
                    <select id="invoice-format" name="invoice-format">
                        <option value="estandar">Estándar</option>
                        <option value="compacto">Compacto</option>
                    </select>
                </div>

                <div class="share-options">
                    <label>Compartir:</label>
                    <button id="share-whatsapp-btn" title="Compartir por WhatsApp" class="button success"><i class="fab fa-whatsapp"></i> WhatsApp</button>
                    <button id="share-email-btn" title="Compartir por Correo Electrónico" class="button danger"><i class="fas fa-envelope"></i> Correo</button>
                </div>
                <div class="export-options" id="share-format-dropdown"> <!-- Eliminada clase hidden aquí -->
                    <div class="form-group">
                        <label for="export-format">Exportar como:</label>
                        <select id="export-format" name="export-format">
                            <option value="pdf">PDF</option>
                            <option value="png">PNG</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="export-size">Tamaño:</label>
                        <select id="export-size" name="export-size">
                            <option value="tirilla">Tirilla</option>
                            <option value="carta">Carta</option>
                            <option value="a4">A4</option>
                        </select>
                    </div>
                    <button id="export-btn" class="button primary">Exportar</button>
                </div>
            </div>
        </section>

        <div class="status-message" id="status-message">
            <!-- Mensajes de estado se mostrarán aquí -->
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', () => {
    // Elementos DOM
    const logoPreview = document.getElementById('logo-preview');
    const uploadLogoBtn = document.getElementById('upload-logo-btn');
    const uploadLogoInput = document.getElementById('upload-logo-input');
    const businessDetailsTextarea = document.getElementById('business-details');
    const selectClient = document.getElementById('select-client');
    const newClientNameInput = document.getElementById('new-client-name');
    const newClientEmailInput = document.getElementById('new-client-email');
    const newClientAddressInput = document.getElementById('new-client-address');
    const newClientPhoneInput = document.getElementById('new-client-phone');
    const newClientPaymentStatusSelect = document.getElementById('new-client-payment-status');
    const clientPaymentStatusDiv = document.getElementById('client-payment-status');
    const invoiceDateInput = document.getElementById('invoice-date'); 
    const invoiceNumberInput = document.getElementById('invoice-number'); 
    const itemDescriptionInput = document.getElementById('item-description');
    const itemQuantityInput = document.getElementById('item-quantity');
    const itemPriceInput = document.getElementById('item-price');
    const addItemBtn = document.getElementById('add-item-btn');
    const itemsList = document.getElementById('items-list');
    const subtotalInput = document.getElementById('subtotal');
    const taxInput = document.getElementById('tax');
    const totalInput = document.getElementById('total');
    const generateInvoiceBtn = document.getElementById('generate-invoice-btn');
    const searchCodeInput = document.getElementById('search-code');
    const searchInvoiceBtn = document.getElementById('search-invoice-btn');
    const searchResultsDiv = document.getElementById('search-results');
    const shareWhatsappBtn = document.getElementById('share-whatsapp-btn');
    const shareEmailBtn = document.getElementById('share-email-btn');
    const shareFormatDropdown = document.getElementById('share-format-dropdown');
    const exportFormatSelect = document.getElementById('export-format');
    const exportSizeSelect = document.getElementById('export-size');
    const exportBtn = document.getElementById('export-btn');
    const statusMessageDiv = document.getElementById('status-message');
    const productListDatalist = document.getElementById('product-list');
    const clientActionsDiv = document.getElementById('client-actions');
    const deleteClientBtn = document.getElementById('delete-client-btn');
    const recoverClientBtn = document.getElementById('recover-client-btn');
    const editClientForm = document.getElementById('edit-client-form');
    const editClientNameInput = document.getElementById('edit-client-name');
    const editClientEmailInput = document.getElementById('edit-client-email');
    const editClientAddressInput = document.getElementById('edit-client-address');
    const editClientPhoneInput = document.getElementById('edit-client-phone');
    const editClientPaymentStatusSelect = document.getElementById('edit-client-payment-status');
    const saveClientBtn = document.getElementById('save-client-btn');

    const apiUrl = 'https://script.google.com/macros/s/AKfycbw_qXDERIpjunZO-I5gGU59_IF7t8gYFWuPE1Gl6SAnvhmcj8wheEXys7VDuYxJ3p1SXQ/exec';

    let items = [];
    let clientsData = [];
    let productsData = [];
    let generatedCodes = JSON.parse(localStorage.getItem('generatedCodes')) || [];
    let invoiceCounter = parseInt(localStorage.getItem('invoiceCounter')) || 0;
    let selectedClient = null;

    const savedLogo = localStorage.getItem('businessLogo');
    const savedBusinessDetails = localStorage.getItem('businessDetails');

    if (savedLogo) {
        logoPreview.src = savedLogo;
    }
    if (savedBusinessDetails) {
        businessDetailsTextarea.value = savedBusinessDetails;
    }

    function showStatusMessage(message, type = 'error', duration = 3000) {
        statusMessageDiv.textContent = message;
        statusMessageDiv.className = `status-message ${type}`; 
        statusMessageDiv.style.opacity = 1;
        setTimeout(() => {
            statusMessageDiv.style.opacity = 0;
            setTimeout(() => {
                if (statusMessageDiv.textContent === message) { 
                    statusMessageDiv.textContent = '';
                    statusMessageDiv.className = 'status-message';
                }
            }, 500);
        }, duration);
    }

    async function loadClients() {
        try {
            const response = await fetch(apiUrl + '?action=getClients');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const apiResponse = await response.json(); // Primero parsea la respuesta general de la API
            if (apiResponse.status === 'success') {
                 clientsData = apiResponse.data; // Accede a los datos reales
                 populateClientDropdown();
            } else {
                 throw new Error(apiResponse.message || 'Error desconocido al cargar clientes desde API.');
            }
        } catch (error) {
            console.error('Error al cargar clientes:', error);
            showStatusMessage('Error al cargar clientes: ' + error.message, 'error');
        }
    }

    async function loadProducts() {
        try {
            const response = await fetch(apiUrl + '?action=getProducts');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const apiResponse = await response.json(); // Parsea la respuesta de la API
            if(apiResponse.status === 'success'){
                // El backend para getProducts devuelve un *string* que es un JSON de un array.
                // Por lo tanto, necesitamos un segundo parse.
                productsData = JSON.parse(apiResponse.data);
                populateProductList();
            } else {
                throw new Error(apiResponse.message || 'Error desconocido al cargar productos desde API.');
            }
        } catch (error) { // <<-- LLAVE AÑADIDA AQUÍ
            console.error('Error al cargar productos:', error);
            showStatusMessage('Error al cargar productos: ' + error.message, 'error');
        } // <<-- LLAVE AÑADIDA AQUÍ
    }

    function populateClientDropdown() {
        selectClient.innerHTML = '<option value="">-- Seleccionar Cliente --</option>';
        if(Array.isArray(clientsData)) {
            clientsData.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = client.name + (client.deleted ? ' (Eliminado)' : '');
                if (client.deleted) {
                    option.classList.add('deleted');
                }
                selectClient.appendChild(option);
            });
        } else {
             console.warn("clientsData no es un array:", clientsData);
        }
    }

    function populateProductList() {
        productListDatalist.innerHTML = '';
        if(Array.isArray(productsData)) {
            productsData.forEach(product => {
                const option = document.createElement('option');
                option.value = product.description;
                productListDatalist.appendChild(option);
            });
        } else {
            console.warn("Products data no es un array:", productsData);
        }
    }

    function updateClientPaymentStatus() {
        if (selectedClient && selectedClient.paymentStatus) {
            clientPaymentStatusDiv.textContent = `Estado de Pago: ${selectedClient.paymentStatus === 'paid' ? 'PAGADO' : 'PENDIENTE'}`;
            clientPaymentStatusDiv.className = `client-payment-status payment-status-${selectedClient.paymentStatus.toLowerCase()}`; 
        } else {
            clientPaymentStatusDiv.textContent = '';
            clientPaymentStatusDiv.className = 'client-payment-status';
        }
    }

    function showHideClientActions() {
        if (selectedClient) {
            clientActionsDiv.classList.remove('hidden');
            editClientForm.classList.remove('hidden');
            if (selectedClient.deleted) {
                deleteClientBtn.classList.add('hidden');
                recoverClientBtn.classList.remove('hidden');
            } else {
                deleteClientBtn.classList.remove('hidden');
                recoverClientBtn.classList.add('hidden');
            }
        } else {
            clientActionsDiv.classList.add('hidden');
            editClientForm.classList.add('hidden');
        }
    }

    function populateEditClientForm() {
        if (selectedClient) {
            editClientNameInput.value = selectedClient.name || '';
            editClientEmailInput.value = selectedClient.email || '';
            editClientAddressInput.value = selectedClient.address || '';
            editClientPhoneInput.value = selectedClient.phone || '';
            editClientPaymentStatusSelect.value = selectedClient.paymentStatus || 'pending';
        } else {
            editClientNameInput.value = '';
            editClientEmailInput.value = '';
            editClientAddressInput.value = '';
            editClientPhoneInput.value = '';
            editClientPaymentStatusSelect.value = 'pending';
        }
    }

    selectClient.addEventListener('change', (event) => {
        const clientId = event.target.value;
        selectedClient = clientsData.find(c => String(c.id) === String(clientId)); 
        updateClientPaymentStatus();
        showHideClientActions();
        populateEditClientForm();
    });

    uploadLogoBtn.addEventListener('click', () => {
        uploadLogoInput.click();
    });

    uploadLogoInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                logoPreview.src = e.target.result;
                localStorage.setItem('businessLogo', e.target.result);
            };
            reader.readAsDataURL(file);
        }
    });

    businessDetailsTextarea.addEventListener('input', (event) => {
        localStorage.setItem('businessDetails', event.target.value);
    });

    itemDescriptionInput.addEventListener('input', () => {
        const description = itemDescriptionInput.value;
        const product = productsData.find(p => p.description === description);
        if (product) {
            itemPriceInput.value = (typeof product.price === 'number' ? product.price : 0).toFixed(2);
        }
    });

    addItemBtn.addEventListener('click', () => {
        const description = itemDescriptionInput.value;
        const quantity = parseFloat(itemQuantityInput.value) || 1;
        let price = parseFloat(itemPriceInput.value) || 0.00;

        const product = productsData.find(p => p.description === description);
        if (product && typeof product.price === 'number') {
            price = product.price;
        }

        if (description && quantity > 0 && price >= 0) {
            const item = { description, quantity, price };
            items.push(item);
            renderItems();
            updateTotals();

            itemDescriptionInput.value = '';
            itemQuantityInput.value = '1';
            itemPriceInput.value = '0.00';
        } else {
            showStatusMessage('Por favor, ingrese una descripción válida, cantidad y precio.', 'error');
        }
    });

    function renderItems() {
        itemsList.innerHTML = ''; 
        items.forEach((item, index) => {
            const newRow = itemsList.insertRow();
            newRow.insertCell().textContent = item.description;
            newRow.insertCell().textContent = item.quantity;
            newRow.insertCell().textContent = item.price.toFixed(2);
            newRow.insertCell().textContent = (item.quantity * item.price).toFixed(2);

            const actionsCell = newRow.insertCell();
            const removeBtn = document.createElement('button');
            removeBtn.classList.add('button', 'danger', 'small', 'remove-item-btn');
            removeBtn.textContent = 'Eliminar';
            removeBtn.onclick = () => {
                items.splice(index, 1); 
                renderItems(); 
                updateTotals();
            };
            actionsCell.appendChild(removeBtn);
        });
    }


    function updateTotals() {
        let subtotal = 0;
        items.forEach(item => {
            subtotal += item.quantity * item.price;
        });
        subtotalInput.value = subtotal.toFixed(2);

        const taxRate = parseFloat(taxInput.value) || 0;
        const taxAmount = subtotal * (taxRate / 100);
        const total = subtotal + taxAmount;
        totalInput.value = total.toFixed(2);
    }

    taxInput.addEventListener('input', updateTotals);

    function getCurrentDateTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    function generateUniqueCodePart() { 
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; 
        let codePart = '';
        for (let i = 0; i < 6; i++) { 
            codePart += characters.charAt(Math.floor(Math.random() * characters.length));
        }
        return codePart;
    }

    async function getUniqueInvoiceCode() {
        let newCode;
        let attempts = 0;
        const maxAttempts = 10; 
        do {
            newCode = generateUniqueCodePart();
            try {
                const response = await fetch(`${apiUrl}?action=checkCode&code=${newCode}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const apiResponse = await response.json();
                if(apiResponse.status === 'success'){
                    if (!apiResponse.data.exists) {
                        generatedCodes.push(newCode); 
                        localStorage.setItem('generatedCodes', JSON.stringify(generatedCodes)); 
                        return newCode; 
                    }
                } else {
                    throw new Error(apiResponse.message || 'Error verificando código.');
                }
            } catch (error) {
                console.error("Error al verificar código:", error);
                showStatusMessage("Error al verificar código único: " + error.message, "error");
                return null; 
            }
            attempts++;
        } while (attempts < maxAttempts);
        showStatusMessage("No se pudo generar un código de factura único tras varios intentos.", "error");
        return null; 
    }

    async function getCurrentInvoiceNumberFromAPI() { 
        try {
            const response = await fetch(apiUrl + '?action=getInvoiceNumber');
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const apiResponse = await response.json();
            if(apiResponse.status === 'success'){
                let currentNumber = parseInt(apiResponse.data.number) || 0;
                currentNumber++; 

                const updateResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'updateInvoiceNumber', number: currentNumber })
                });
                if (!updateResponse.ok) {
                    const errorData = await updateResponse.json();
                    throw new Error(errorData.message || `HTTP error al actualizar número de factura! status: ${updateResponse.status}`);
                }
                invoiceNumberInput.value = String(currentNumber).padStart(3, '0');
                return String(currentNumber).padStart(3, '0');
            } else {
                 throw new Error(apiResponse.message || 'Error al obtener número de factura.');
            }
        } catch (error) {
            console.error('Error al obtener/actualizar número de factura desde API:', error);
            showStatusMessage('Error al obtener número de factura: ' + error.message, 'error');
            invoiceCounter++;
            localStorage.setItem('invoiceCounter', invoiceCounter);
            invoiceNumberInput.value = String(invoiceCounter).padStart(3, '0');
            return String(invoiceCounter).padStart(3, '0');
        }
    }

    function validateClientData(data) {
        if (!data.name || !data.name.trim()) return 'El nombre del cliente es obligatorio.';
        if (!data.email || !data.email.trim()) return 'El email del cliente es obligatorio.';
        if (data.email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(data.email.trim())) {
            return 'El formato del email no es válido.';
        }
        return null;
    }

    function getClientDataFromForm(formType) { 
        if (formType === 'new') {
            return {
                name: newClientNameInput.value.trim(),
                email: newClientEmailInput.value.trim(),
                address: newClientAddressInput.value.trim(),
                phone: newClientPhoneInput.value.trim(),
                paymentStatus: newClientPaymentStatusSelect.value,
            };
        } else if (formType === 'edit') {
            return {
                name: editClientNameInput.value.trim(),
                email: editClientEmailInput.value.trim(),
                address: editClientAddressInput.value.trim(),
                phone: editClientPhoneInput.value.trim(),
                paymentStatus: editClientPaymentStatusSelect.value,
            };
        }
        return {};
    }

    async function saveInvoiceToAPI(invoiceData, newClientPayload) { 
        const payload = { action: 'saveInvoice', invoiceData: invoiceData };
        if (newClientPayload) {
            payload.newClient = newClientPayload;
        }
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json(); // Siempre intenta parsear
            if (!response.ok || result.status !== 'success') {
                 throw new Error(result.message || `HTTP error! status: ${response.status}`);
            }

            console.log('Resultado del guardado:', result.data); // Accede a .data
            showStatusMessage(`Factura guardada con número ${invoiceData.number} y código: ${invoiceData.code}`, 'success');

            newClientNameInput.value = '';
            newClientEmailInput.value = '';
            newClientAddressInput.value = '';
            newClientPhoneInput.value = '';
            newClientPaymentStatusSelect.value = 'pending';
            items = []; 
            renderItems(); 
            updateTotals(); 

            if (newClientPayload || selectedClient) await loadClients(); 
            selectClient.value = ""; 
            selectedClient = null;
            showHideClientActions();
            populateEditClientForm();


        } catch (error) {
            console.error('Error al guardar la factura:', error);
            showStatusMessage('Error al guardar la factura: ' + error.message, 'error');
        }
    }

    async function deleteClient(clientId) {
        if (!confirm("¿Está seguro de que desea eliminar este cliente?")) {
            return;
        }
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deleteClient', clientId: clientId })
            });
            const result = await response.json();
            if (!response.ok || result.status !== 'success') throw new Error(result.message || `HTTP error! status: ${response.status}`);
            
            console.log('Resultado de la eliminación:', result.data);
            showStatusMessage(result.data.message || 'Cliente marcado como eliminado.', 'success');
            await loadClients(); 
            selectClient.value = ''; 
            selectedClient = null;
            showHideClientActions();
            populateEditClientForm();
        } catch (error) {
            console.error('Error al eliminar cliente:', error);
            showStatusMessage('Error al eliminar cliente: ' + error.message, 'error');
        }
    }

    async function recoverClient(clientId) {
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'recoverClient', clientId: clientId })
            });
            const result = await response.json();
            if (!response.ok || result.status !== 'success') throw new Error(result.message || `HTTP error! status: ${response.status}`);

            console.log('Resultado de la recuperación:', result.data);
            showStatusMessage(result.data.message ||'Cliente recuperado correctamente.', 'success');
            await loadClients();
            const recovered = clientsData.find(c => String(c.id) === String(clientId));
            if(recovered) {
                 selectClient.value = clientId; 
                 selectedClient = recovered;
            } else {
                selectClient.value = '';
                selectedClient = null;
            }
            showHideClientActions();
            populateEditClientForm();

        } catch (error) {
            console.error('Error al recuperar cliente:', error);
            showStatusMessage('Error al recuperar cliente: ' + error.message, 'error');
        }
    }

    async function saveClientChanges() {
        if (!selectedClient) return;

        const clientDataToSave = getClientDataFromForm('edit');
        const validationError = validateClientData(clientDataToSave);
        if (validationError) {
            showStatusMessage(validationError, 'error');
            return;
        }

        const updatedClientData = {
            id: selectedClient.id,
            ...clientDataToSave
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'saveClientChanges', clientData: updatedClientData })
            });
            const result = await response.json();
            if (!response.ok || result.status !== 'success') throw new Error(result.message ||`HTTP error! status: ${response.status}`);
            
            console.log('Resultado de guardar cambios:', result.data);
            showStatusMessage(result.data.message || 'Cambios del cliente guardados.', 'success');
            await loadClients(); 
            selectClient.value = selectedClient.id;
            selectedClient = clientsData.find(c => String(c.id) === String(selectedClient.id));
            populateEditClientForm(); 

        } catch (error) {
            console.error('Error al guardar cambios del cliente:', error);
            showStatusMessage('Error al guardar cambios del cliente: ' + error.message, 'error');
        }
    }

    generateInvoiceBtn.addEventListener('click', async () => {
        if (items.length === 0) {
            showStatusMessage("No se han agregado items a la factura.", "error");
            return;
        }

        const currentDate = getCurrentDateTime();
        const invoiceNumber = await getCurrentInvoiceNumberFromAPI();
        if (!invoiceNumber) return; 

        const uniqueCode = await getUniqueInvoiceCode();
        if (!uniqueCode) return; 

        let clientInfo = null;
        let newClientPayload = null; 
        const selectedClientId = selectClient.value;

        if (selectedClientId) {
            clientInfo = clientsData.find(c => String(c.id) === String(selectedClientId));
            if (clientInfo && clientInfo.deleted) {
                showStatusMessage("No se puede generar factura para un cliente eliminado. Por favor, recupere el cliente o seleccione uno diferente.", "error");
                return;
            }
        } else if (newClientNameInput.value.trim() !== '' || newClientEmailInput.value.trim() !== '') { 
            newClientPayload = getClientDataFromForm('new');
            const validationError = validateClientData(newClientPayload);
            if (validationError) {
                showStatusMessage(validationError, 'error');
                return;
            }
            clientInfo = { 
                ...newClientPayload,
                id: 'NEW_CLIENT_PLACEHOLDER' 
            };
        } else {
            showStatusMessage("Debe seleccionar un cliente existente o ingresar los datos de un nuevo cliente.", "error");
            return;
        }

        invoiceDateInput.value = currentDate.split(' ')[0]; 

        const invoiceData = {
            code: uniqueCode,
            date: currentDate,
            number: invoiceNumber,
            clientId: clientInfo ? (selectedClientId ? clientInfo.id : null) : null, 
            clientName: clientInfo ? clientInfo.name : "Cliente General", 
            clientEmail: clientInfo ? clientInfo.email : "",
            clientAddress: clientInfo ? clientInfo.address : "",
            clientPhone: clientInfo ? clientInfo.phone : "",
            clientPaymentStatus: clientInfo ? clientInfo.paymentStatus : "pending",
            logo: logoPreview.src,
            businessDetails: businessDetailsTextarea.value,
            items: items,
            subtotal: parseFloat(subtotalInput.value) || 0,
            taxRate: parseFloat(taxInput.value) || 0,
            total: parseFloat(totalInput.value) || 0,
            format: document.getElementById('invoice-format').value,
        };

        await saveInvoiceToAPI(invoiceData, newClientPayload);
    });

    searchInvoiceBtn.addEventListener('click', async () => {
        const searchCode = searchCodeInput.value.trim();
        if (!searchCode) {
            showStatusMessage("Por favor, ingrese un código de factura para buscar.", "error");
            return;
        }
        try {
            const response = await fetch(`${apiUrl}?action=findInvoice&code=${searchCode}`);
            const result = await response.json();
            if (!response.ok || result.status !== 'success') throw new Error(result.message || `HTTP error! status: ${response.status}`);

            if (result.data.invoice) {
                const invoice = result.data.invoice;
                const resultsHTML = `
                    <h3>Factura Encontrada</h3>
                    <p><strong>Código:</strong> ${invoice.code}</p>
                    <p><strong>Número:</strong> ${invoice.number}</p>
                    <p><strong>Fecha:</strong> ${new Date(invoice.date).toLocaleString('es-ES')}</p>
                    <p><strong>Cliente:</strong> ${invoice.clientName || 'N/A'}</p>
                    <p><strong>Total:</strong> ${(invoice.total !== undefined ? parseFloat(invoice.total) : 0).toFixed(2)}</p>
                `;
                searchResultsDiv.innerHTML = resultsHTML;
                searchResultsDiv.classList.add('show'); 
            } else {
                searchResultsDiv.innerHTML = '<p>No se encontró ninguna factura con ese código.</p>';
                searchResultsDiv.classList.add('show'); 
            }
        } catch (error) {
            console.error('Error al buscar factura:', error);
            searchResultsDiv.innerHTML = '<p>Error al buscar la factura: ' + error.message + '</p>';
            searchResultsDiv.classList.add('show'); 
        }
    });

    shareWhatsappBtn.addEventListener('click', () => {
        alert("La funcionalidad para compartir en WhatsApp se implementará generando un mensaje/link en el backend.");
    });

    shareEmailBtn.addEventListener('click', () => {
        if (shareFormatDropdown.classList.contains('show')) {
            shareFormatDropdown.classList.remove('show');
        } else {
            shareFormatDropdown.classList.add('show');
        }
    });

    exportBtn.addEventListener('click', () => {
        const exportFormat = exportFormatSelect.value;
        const exportSize = exportSizeSelect.value;
        alert(`Se solicitará la exportación en formato ${exportFormat} y tamaño ${exportSize} al backend.`);
        shareFormatDropdown.classList.remove('show'); 
    });

    deleteClientBtn.addEventListener('click', () => {
        if (selectedClient) {
            deleteClient(selectedClient.id);
        }
    });

    recoverClientBtn.addEventListener('click', () => {
        if (selectedClient) {
            recoverClient(selectedClient.id);
        }
    });

    saveClientBtn.addEventListener('click', () => {
        saveClientChanges();
    });

    loadClients();
    loadProducts();
    showHideClientActions(); 
    populateEditClientForm(); 

});
	</script>
</body>
</html>